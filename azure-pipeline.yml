trigger:
- test

pr:
- test

pool:
  vmImage: 'ubuntu-latest'

jobs:
  - job: terraform_approval
    displayName: "Terraform Approval"
    steps:
      - script: 
          echo "Terraform Approval Job"
        displayName: 'Terraform Approval'
        condition: succeededOrFailed()

  - job: manual_approval
    displayName: "Manual Approval"
    dependsOn: terraform_approval
    pool:
      vmImage: 'ubuntu-latest' 
    steps:
      - script: 
          echo "Manual Approval Job"
        displayName: 'Manual Approval'
        condition: succeededOrFailed()

      - script: |
          ls -la
          pwd
          cd $(Build.SourcesDirectory)/rose
          pwd
          terraform init
        displayName: 'Terraform Init'

      - script: |
          cd $(Build.SourcesDirectory)/rose
          terraform validate
        displayName: 'Terraform Validate'

      - script: |
          az login 
        displayName: 'Azure Login'  

      - script: |
          cd $(Build.SourcesDirectory)/rose
          terraform plan \
          -var "vm_password=$(vm_password)" \
        displayName: 'Terraform Plan'

  - job: manual_intervention
    displayName: 'Manual Approval Intervention'
    dependsOn: manual_approval
    pool: server
    steps:
      - task: ManualValidation@0
        timeoutInMinutes: 5
        inputs:
          instructions: 'Please review and manually approve the Terraform changes.'

  - job: apply_changes
    displayName: 'Apply Terraform Changes'
    dependsOn: manual_intervention
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - script: |
          cd $(Build.SourcesDirectory)/rose
          terraform init
          az login 
          terraform apply -auto-approve \
          -var "vm_password=$(vm_password)" \

        displayName: 'Apply Terraform Changes'
